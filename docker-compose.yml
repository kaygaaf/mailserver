version: '3.8'

# Mailu Email Server - Zero-config deployment
# All settings auto-generated on first run

services:
  # Front reverse proxy
  front:
    image: mailu/nginx:2.0
    restart: always
    environment:
      - DOMAIN=${DOMAIN:-kayorama.nl}
      - HOSTNAMES=${HOSTNAMES:-mail.kayorama.nl}
      - POSTMASTER=admin
      - TLS_FLAVOR=letsencrypt
      - ADMIN_WEB=admin
      - WEBMAIL=webmail
      - SECRET_KEY=${SECRET_KEY}
      - AUTH_RATELIMIT_IP=60/hour
      - AUTH_RATELIMIT_USER=30/hour
      - DISABLE_STATISTICS=true
      - SUBNET=192.168.200.0/24
      - MESSAGE_SIZE_LIMIT=50000000
    ports:
      - "80:80"
      - "443:443"
      - "25:25"
      - "465:465"
      - "587:587"
      - "110:110"
      - "995:995"
      - "143:143"
      - "993:993"
    volumes:
      - mailu_certs:/certs
      - mailu_overrides:/overrides
    networks:
      - mailu
      - coolify
    depends_on:
      - admin
      - webmail

  # Admin interface
  admin:
    image: mailu/admin:2.0
    restart: always
    environment:
      - DOMAIN=${DOMAIN:-kayorama.nl}
      - HOSTNAMES=${HOSTNAMES:-mail.kayorama.nl}
      - SECRET_KEY=${SECRET_KEY}
      - INITIAL_ADMIN_ACCOUNT=admin
      - INITIAL_ADMIN_DOMAIN=${DOMAIN:-kayorama.nl}
      - INITIAL_ADMIN_PW=${ADMIN_PASSWORD:-changeme123}
      - DB_FLAVOR=sqlite
      - WEB_ADMIN=true
    volumes:
      - mailu_data:/data
      - mailu_certs:/certs
    networks:
      - mailu

  # Webmail
  webmail:
    image: mailu/roundcube:2.0
    restart: always
    environment:
      - ROUNDCUBE_PLUGINS=archive,zipdownload,managesieve,markasjunk
    volumes:
      - webmail_data:/data
    networks:
      - mailu

  # IMAP
  imap:
    image: mailu/dovecot:2.0
    restart: always
    environment:
      - DOMAIN=${DOMAIN:-kayorama.nl}
      - SECRET_KEY=${SECRET_KEY}
    volumes:
      - mailu_data:/data
      - mailu_certs:/certs
    networks:
      - mailu

  # SMTP
  smtp:
    image: mailu/postfix:2.0
    restart: always
    environment:
      - DOMAIN=${DOMAIN:-kayorama.nl}
      - HOSTNAMES=${HOSTNAMES:-mail.kayorama.nl}
      - SECRET_KEY=${SECRET_KEY}
      - MESSAGE_SIZE_LIMIT=50000000
    volumes:
      - mailu_data:/data
      - mailu_certs:/certs
    networks:
      - mailu

  # Antispam
  antispam:
    image: mailu/rspamd:2.0
    restart: always
    environment:
      - SECRET_KEY=${SECRET_KEY}
    volumes:
      - mailu_filter:/var/lib/rspamd
    networks:
      - mailu

  # Redis
  redis:
    image: redis:alpine
    restart: always
    volumes:
      - redis_data:/data
    networks:
      - mailu

volumes:
  mailu_data:
  mailu_certs:
  mailu_overrides:
  mailu_filter:
  webmail_data:
  redis_data:

networks:
  mailu:
    driver: bridge
  coolify:
    external: true
